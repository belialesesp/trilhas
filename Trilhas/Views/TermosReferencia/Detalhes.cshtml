@using Trilhas.Data.Model.TermosReferencia
@{
    var termo = ViewBag.Termo as TermoDeReferencia;
    ViewData["Title"] = "Detalhes - " + termo?.Titulo;
    Layout = null;
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">@termo.Titulo</h2>
                <p class="text-muted mb-0">
                    <strong>Demandante:</strong> @termo.Demandante | 
                    <strong>Ano:</strong> @termo.Ano | 
                    <strong>Status:</strong> <span class="badge badge-info">@termo.Status</span>
                </p>
            </div>
            <div>
                <a href="/TermosReferencia/Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Contratações por Curso
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="cursosTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th width="5%"></th>
                                    <th width="40%">Curso</th>
                                    <th width="15%">Total Necessário</th>
                                    <th width="15%">Contratados</th>
                                    <th width="15%">Atestados</th>
                                    <th width="10%">Data Oferta</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    // Group items by course
                                    var cursos = termo.Itens
                                        .Where(i => i.DeletionTime == null)
                                        .GroupBy(i => i.Curso)
                                        .OrderBy(g => g.Key);
                                }

                                @foreach (var curso in cursos)
                                {
                                    var cursoId = "curso_" + Math.Abs(curso.Key.GetHashCode());
                                    var totalNecessario = curso.Sum(i => i.Quantidade);
                                    var totalContratados = curso.Sum(i => i.ContratadosCount);
                                    var totalAtestados = curso.Sum(i => i.AtesteCount);
                                    var firstItem = curso.First();
                                    
                                    <tr class="curso-row" data-target="#@cursoId" style="cursor: pointer;">
                                        <td class="text-center">
                                            <i class="fas fa-chevron-right expand-icon"></i>
                                        </td>
                                        <td><strong>@curso.Key</strong></td>
                                        <td>
                                            <span class="badge badge-secondary">@totalNecessario profissionais</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-@(totalContratados == totalNecessario ? "success" : "warning")">
                                                @totalContratados / @totalNecessario
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge badge-@(totalAtestados == totalNecessario ? "success" : "secondary")">
                                                @totalAtestados / @totalNecessario
                                            </span>
                                        </td>
                                        <td>
                                            @if (firstItem.DataOferta.HasValue)
                                            {
                                                @firstItem.DataOferta.Value.ToString("dd/MM/yyyy")
                                                <br/>
                                                <small class="text-muted">@firstItem.MesExecucao</small>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                    
                                    <!-- Expandable details row -->
                                    <tr class="collapse-row" id="@cursoId" style="display: none;">
                                        <td colspan="6" class="p-0">
                                            <div class="nested-table-container">
                                                <table class="table table-sm table-bordered mb-0">
                                                    <thead class="bg-light">
                                                        <tr>
                                                            <th width="25%">Categoria</th>
                                                            <th width="10%">Slot</th>
                                                            <th width="35%">Contrato</th>
                                                            <th width="15%">Data Contratação</th>
                                                            <th width="10%">Ateste</th>
                                                            <th width="5%">Ações</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var item in curso)
                                                        {
                                                            @foreach (var slot in item.Slots.OrderBy(s => s.NumeroSlot))
                                                            {
                                                                <tr class="slot-row" data-slot-id="@slot.Id">
                                                                    <td>
                                                                        @if (slot.NumeroSlot == 1)
                                                                        {
                                                                            <span class="badge badge-pill badge-@GetCategoryBadgeColor(item.Profissional)">
                                                                                @item.Profissional.Replace("_", " ")
                                                                            </span>
                                                                        }
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <small class="text-muted">#@slot.NumeroSlot</small>
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" 
                                                                               class="form-control form-control-sm contractor-name" 
                                                                               data-slot-id="@slot.Id"
                                                                               value="@slot.NomeContratado"
                                                                               placeholder="Número do processo E-Docs">
                                                                    </td>
                                                                    <td>
                                                                        @if (slot.DataContratacao.HasValue)
                                                                        {
                                                                            <small>@slot.DataContratacao.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                                                        }
                                                                        else
                                                                        {
                                                                            <small class="text-muted">-</small>
                                                                        }
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input type="checkbox" 
                                                                                   class="custom-control-input ateste-checkbox" 
                                                                                   id="ateste_@slot.Id"
                                                                                   data-slot-id="@slot.Id"
                                                                                   @(slot.Ateste ? "checked" : "")>
                                                                            <label class="custom-control-label" for="ateste_@slot.Id"></label>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <button class="btn btn-sm btn-success save-slot-btn" 
                                                                                data-slot-id="@slot.Id"
                                                                                title="Salvar">
                                                                            <i class="fas fa-save"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetCategoryBadgeColor(string categoria)
    {
        return categoria switch
        {
            "DOCENTE" => "primary",
            "MODERADOR" => "info",
            "DOCENTE_CONTEUDISTA" => "success",
            _ => "secondary"
        };
    }
}

<style>
    .curso-row:hover {
        background-color: #f8f9fa;
    }
    
    .expand-icon {
        transition: transform 0.3s;
    }
    
    .curso-row.expanded .expand-icon {
        transform: rotate(90deg);
    }
    
    .nested-table-container {
        background-color: #f8f9fa;
        padding: 15px;
    }
    
    .slot-row {
        background-color: white;
    }
    
    .contractor-name:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
</style>

<script>
$(document).ready(function() {
    // Expand/collapse course rows
    $('.curso-row').click(function() {
        var targetId = $(this).data('target');
        var $target = $(targetId);
        
        if ($target.is(':visible')) {
            $target.slideUp(200);
            $(this).removeClass('expanded');
        } else {
            $target.slideDown(200);
            $(this).addClass('expanded');
        }
    });
    
    // Save slot data
    $('.save-slot-btn').click(function() {
        var slotId = $(this).data('slot-id');
        var $row = $(this).closest('.slot-row');
        var nome = $row.find('.contractor-name').val();
        var ateste = $row.find('.ateste-checkbox').is(':checked');
        
        $.ajax({
            url: '/TermosReferencia/SalvarSlot',
            method: 'POST',
            data: {
                slotId: slotId,
                nomeContratado: nome,
                ateste: ateste
            },
            success: function(response) {
    if (response.success) {
        toastr.success('Dados salvos com sucesso!');
        // Don't reload the page
    } else {
        toastr.error(response.message || 'Erro ao salvar');
    }
},
            error: function() {
                toastr.error('Erro ao comunicar com o servidor');
            }
        });
    });
    
    // Auto-save on checkbox change
$('.ateste-checkbox').change(function(e) {
    e.preventDefault(); // Prevent default checkbox behavior
    
    var slotId = $(this).data('slot-id');
    var $row = $(this).closest('.slot-row');
    var nome = $row.find('.contractor-name').val();
    var ateste = $(this).is(':checked');
    
    $.ajax({
        url: '/TermosReferencia/SalvarSlot',
        method: 'POST',
        data: {
            slotId: slotId,
            nomeContratado: nome,
            ateste: ateste
        },
        success: function(response) {
            if (response.success) {
                toastr.success('Ateste salvo!');
                // Don't reload - just update the badge counts
                updateCounts();
            } else {
                toastr.error(response.message || 'Erro ao salvar');
            }
        },
        error: function() {
            toastr.error('Erro ao comunicar com o servidor');
        }
    });
});

// Function to update counts without reloading
function updateCounts() {
    // You can add logic here to update the badge counts
    // For now, we'll just keep it simple
}
});
</script>
