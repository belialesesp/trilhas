@using Trilhas.Data.Model.TermosReferencia
@model TermoDeReferencia

@{
    ViewData["Title"] = "Editar - " + Model.Titulo;
    Layout = null;
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/lib/font-awesome/css/all.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

        <style>
                body {
                    background-color: #f5f5f5;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }

                .page-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 2rem 0;
                    margin-bottom: 2rem;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }

                .card {
                    border: none;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    margin-bottom: 1.5rem;
                    border-radius: 8px;
                }

                .card-header {
                    border-bottom: none;
                    border-radius: 8px 8px 0 0 !important;
                    font-weight: 600;
                }

                .table thead th {
                    border-bottom: 2px solid #dee2e6;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 0.85rem;
                    letter-spacing: 0.5px;
                }

                .badge {
                    padding: 0.4rem 0.8rem;
                    font-weight: 500;
                }

                .btn {
                    border-radius: 4px;
                    padding: 0.5rem 1rem;
                    font-weight: 500;
                    transition: all 0.3s;
                }

                .btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                }

                .form-control,
                .form-select {
                    border-radius: 4px;
                    border: 1px solid #ced4da;
                }

                .form-control:focus,
                .form-select:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                }

                .modal-header {
                    border-bottom: none;
                }

                .modal-footer {
                    border-top: none;
                }
        </style>
    </head>
    <body>
        <div class="page-header">
            <div class="container-fluid">
                <h1 class="mb-0">
                    <i class="fas fa-edit"></i> Editar Termo de Referência
                </h1>
            </div>
        </div>

        <div class="container-fluid">
            <!-- Back Button -->
            <div class="row mb-3">
                <div class="col-12">
                    <a href="/TermosReferencia/Detalhes/@Model.Id" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar aos Detalhes
                    </a>
                </div>
            </div>

            <!-- Basic Info Card -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Informações Básicas
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formEditarTermo">
                                <input type="hidden" id="termoId" value="@Model.Id">

                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="titulo"><strong>Título</strong></label>
                                            <input type="text" class="form-control" id="titulo" value="@Model.Titulo">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="status"><strong>Status</strong></label>
                                            <select class="form-control" id="status">
                                                <option value="Rascunho">Rascunho</option>
                                                <option value="Em Análise">Em Análise</option>
                                                <option value="Aprovado">Aprovado</option>
                                                <option value="Em Execução">Em Execução</option>
                                                <option value="Concluído">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="demandante"><strong>Demandante</strong></label>
                                            <input type="text" class="form-control" id="demandante"
                                                   value="@Model.Demandante">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="ano"><strong>Ano</strong></label>
                                            <input type="number" class="form-control" id="ano" value="@Model.Ano">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="dataInicio"><strong>Início</strong></label>
                                            <input type="text" class="form-control" id="dataInicio"
                                                   value="@Model.DataInicio">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="dataTermino"><strong>Término</strong></label>
                                            <input type="text" class="form-control" id="dataTermino"
                                                   value="@Model.DataTermino">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Salvar Informações Básicas
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses/Items Card -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list"></i> Cursos e Profissionais
                            </h5>
                            <button class="btn btn-light btn-sm" id="btnAdicionarItem">
                                <i class="fas fa-plus"></i> Adicionar Item
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="tabelaItens">
                                    <thead class="thead-light">
                                        <tr>
                                            <th width="30%">Curso</th>
                                            <th width="15%">Categoria</th>
                                            <th width="10%">Quantidade</th>
                                            <th width="10%">Mês</th>
                                            <th width="15%">Data Oferta</th>
                                            <th width="10%">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.Itens.Where(i => i.DeletionTime == null))
                                        {
                                            <tr data-item-id="@item.Id">
                                                <td>@item.Curso</td>
                                                <td>
                                                    <span
                                                        class="badge badge-@(item.Profissional == "DOCENTE" ? "primary" : item.Profissional == "MODERADOR" ? "info" : "success")">
                                                        @item.Profissional.Replace("_", " ")
                                                    </span>
                                                </td>
                                                <td><strong>@item.Quantidade</strong></td>
                                                <td>@item.CargaHoraria h</td>
                                                <td>@item.MesExecucao</td>
                                                <td>
                                                    @if (item.DataOferta.HasValue)
                                                    {
                                                        @item.DataOferta.Value.ToString("dd/MM/yyyy")
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning btn-editar" data-item-id="@item.Id"
                                                            title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger btn-deletar" data-item-id="@item.Id"
                                                            title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Add/Edit Item -->
        <div class="modal fade" id="modalItem" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="modalItemTitle">Adicionar Item</h5>
                        <button type="button" class="close text-white" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="formItem">
                            <input type="hidden" id="itemId" value="">

                            <div class="form-group">
                                <label for="itemCurso"><strong>Nome do Curso *</strong></label>
                                <input type="text" class="form-control" id="itemCurso" required
                                       placeholder="Ex: Primeiros Socorros">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="itemProfissional"><strong>Categoria *</strong></label>
                                        <select class="form-control" id="itemProfissional" required>
                                            <option value="">Selecione...</option>
                                            <option value="DOCENTE">DOCENTE</option>
                                            <option value="MODERADOR">MODERADOR</option>
                                            <option value="DOCENTE_CONTEUDISTA">DOCENTE CONTEUDISTA</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="itemQuantidade"><strong>Quantidade *</strong></label>
                                        <input type="number" class="form-control" id="itemQuantidade" min="1" value="1"
                                               required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="itemCargaHoraria"><strong>Carga Horária *</strong></label>
                                        <input type="number" class="form-control" id="itemCargaHoraria" min="1" step="0.5"
                                               value="8" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="itemMes"><strong>Mês de Execução</strong></label>
                                        <select class="form-control" id="itemMes">
                                            <option value="">Selecione...</option>
                                            <option value="JANEIRO">JANEIRO</option>
                                            <option value="FEVEREIRO">FEVEREIRO</option>
                                            <option value="MARÇO">MARÇO</option>
                                            <option value="ABRIL">ABRIL</option>
                                            <option value="MAIO">MAIO</option>
                                            <option value="JUNHO">JUNHO</option>
                                            <option value="JULHO">JULHO</option>
                                            <option value="AGOSTO">AGOSTO</option>
                                            <option value="SETEMBRO">SETEMBRO</option>
                                            <option value="OUTUBRO">OUTUBRO</option>
                                            <option value="NOVEMBRO">NOVEMBRO</option>
                                            <option value="DEZEMBRO">DEZEMBRO</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="itemDataOferta"><strong>Data da Oferta</strong></label>
                                        <input type="date" class="form-control" id="itemDataOferta">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnSalvarItem">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="~/lib/jquery/dist/jquery.min.js"></script>
        <script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

        <script>
            $(document).ready(function () {
            var termoId = $('#termoId').val();
            var isEditing = false;

            // Set the status dropdown value
            var currentStatus = '@Model.Status';
            $('#status').val(currentStatus);

            // Save basic info
            $('#formEditarTermo').submit(function (e) {
            e.preventDefault();

            $.ajax({
            url: '/TermosReferencia/AtualizarTermo',
            method: 'POST',
            data: {
            id: termoId,
            titulo: $('#titulo').val(),
            demandante: $('#demandante').val(),
            ano: $('#ano').val(),
            dataInicio: $('#dataInicio').val(),
            dataTermino: $('#dataTermino').val(),
            status: $('#status').val()
            },
            success: function (response) {
            if (response.success) {
            toastr.success('Informações atualizadas com sucesso!');
            } else {
            toastr.error(response.message || 'Erro ao atualizar');
            }
            },
            error: function () {
            toastr.error('Erro ao comunicar com o servidor');
            }
            });
            });

            // Open modal to add new item
            $('#btnAdicionarItem').click(function () {
            isEditing = false;
            $('#modalItemTitle').text('Adicionar Item');
            $('#formItem')[0].reset();
            $('#itemId').val('');
            $('#modalItem').modal('show');
            });

            // Edit item - FETCH DATA AND POPULATE
            $(document).on('click', '.btn-editar', function () {
            var itemId = $(this).data('item-id');
            var $row = $(this).closest('tr');

            $('#modalItemTitle').text('Editar Item');
            $('#itemId').val(itemId);

            // Populate form from row data
            $('#itemCurso').val($row.find('td:eq(0)').text().trim());

            // Get category from badge
            var categoria = $row.find('.badge').text().trim().replace(' ', '_');
            $('#itemProfissional').val(categoria);

            // Get quantity
            $('#itemQuantidade').val($row.find('td:eq(2)').text().trim());

            // Get month
            $('#itemMes').val($row.find('td:eq(3)').text().trim());

            // Get date if exists
            var dataText = $row.find('td:eq(4)').text().trim();
            if (dataText !== '-') {
            // Convert DD/MM/YYYY to YYYY-MM-DD for date input
            var parts = dataText.split('/');
            if (parts.length === 3) {
            $('#itemDataOferta').val(parts[2] + '-' + parts[1] + '-' + parts[0]);
            }
            }

            $('#modalItem').modal('show');
            });

            // Save item (add or update)
            $('#btnSalvarItem').click(function () {
            if (!$('#formItem')[0].checkValidity()) {
            $('#formItem')[0].reportValidity();
            return;
            }

            var itemId = $('#itemId').val();
            var url = itemId ? '/TermosReferencia/AtualizarItem' : '/TermosReferencia/AdicionarItem';

            var data = {
            termoId: termoId,
            itemId: itemId,
            curso: $('#itemCurso').val(),
            profissional: $('#itemProfissional').val(),
            quantidade: parseInt($('#itemQuantidade').val()),
            cargaHoraria: parseFloat($('#itemCargaHoraria').val()),
            mesExecucao: $('#itemMes').val(),
            dataOferta: $('#itemDataOferta').val()
            };

            $.ajax({
            url: url,
            method: 'POST',
            data: data,
            success: function (response) {
            if (response.success) {
            toastr.success('Item salvo com sucesso!');
            $('#modalItem').modal('hide');
            location.reload();
            } else {
            toastr.error(response.message || 'Erro ao salvar');
            }
            },
            error: function () {
            toastr.error('Erro ao comunicar com o servidor');
            }
            });
            });

            // Delete item
            $(document).on('click', '.btn-deletar', function () {
            if (!confirm('Tem certeza que deseja remover este item?')) {
            return;
            }

            var itemId = $(this).data('item-id');

            $.ajax({
            url: '/TermosReferencia/DeletarItem',
            method: 'POST',
            data: { itemId: itemId },
            success: function (response) {
            if (response.success) {
            toastr.success('Item removido com sucesso!');
            $('tr[data-item-id="' + itemId + '"]').fadeOut(function () {
            $(this).remove();
            });
            } else {
            toastr.error(response.message || 'Erro ao remover');
            }
            },
            error: function () {
            toastr.error('Erro ao comunicar com o servidor');
            }
            });
            });
            });
        </script>
    </body>

</html>