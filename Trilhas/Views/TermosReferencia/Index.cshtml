
@model List<Trilhas.Data.Model.TermosReferencia.TermoDeReferencia>
    @{
    ViewData["Title"] = "Gerenciar Termos de Referência";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="page-header bg-primary text-white p-4 mb-4">
        <h1><i class="fas fa-file-alt"></i> Gerenciar Termos de Referência</h1>
    </div>

    <!-- Upload Section (Accordion Item 1) -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white" style="cursor: pointer;" id="headerUpload" data-toggle="collapse" data-target="#collapseUpload">
            <h5 class="mb-0">
                <i class="fas fa-upload"></i> Upload de Novo Termo
                <i class="fas fa-chevron-down float-right"></i>
            </h5>
        </div>
        <div id="collapseUpload" class="collapse show">
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Instruções:
                    <ul class="mb-0">
                        <li>Faça upload do documento PDF do Termo de Referência</li>
                        <li>O sistema irá extrair automaticamente as informações do demandante, cursos e profissionais necessários</li>
                        <li>Após o processamento, você poderá editar todos os campos extraídos</li>
                        <li>O sistema monitorará automaticamente cursos que iniciam em até 15 dias e ainda precisam de contratações</li>
                    </ul>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="uploadAno">Ano *</label>
                            <input type="number" class="form-control" id="uploadAno" value="2026" min="2020" max="2050">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="uploadFile">Arquivo PDF *</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="uploadFile" accept=".pdf">
                                <label class="custom-file-label" for="uploadFile">Nenhum arquivo escolhido</label>
                            </div>
                            <small class="form-text text-muted">Formato aceito: PDF (até 10MB)</small>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-info btn-lg" id="btnUploadPDF">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Create Manually Section (Accordion Item 2) -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white" style="cursor: pointer;" id="headerCreate" data-toggle="collapse" data-target="#collapseCreate">
            <h5 class="mb-0">
                <i class="fas fa-plus-circle"></i> Criar Novo Termo Manualmente
                <i class="fas fa-chevron-down float-right"></i>
            </h5>
        </div>
        <div id="collapseCreate" class="collapse">
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> Instruções:
                    <ul class="mb-0">
                        <li>Preencha os dados do termo manualmente, sem necessidade de PDF</li>
                        <li>Você definirá o título, demandante, ano e período</li>
                        <li>Após criar, você poderá adicionar cursos e profissionais necessários</li>
                        <li>Edite tudo conforme necessário</li>
                    </ul>
                </div>

                <button type="button" class="btn btn-success btn-lg" id="btnAbrirModalCriar">
                    <i class="fas fa-plus"></i> Criar Termo
                </button>
            </div>
        </div>
    </div>

    <!-- Listing Table -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Termos Cadastrados
            </h5>
        </div>
        <div class="card-body">
            <!-- Your existing table here -->
            <table class="table table-hover" id="tabelaTermos">
                <thead>
                    <tr>
                        <th>Ano</th>
                        <th>Título</th>
                        <th>Demandante</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                     @foreach (var termo in Model)
                    {
                        <tr>
                            <td>@termo.Ano</td>
                            <td>@termo.Titulo</td>
                            <td>@termo.Demandante</td>
                            <td>
                                <span class="badge badge-info">@termo.Status</span>
                            </td>
                            <td>
                                <a href="/TermosReferencia/Detalhes/@termo.Id" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                <a href="/TermosReferencia/Editar/@termo.Id" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                <button class="btn btn-sm btn-danger btn-deletar-termo" data-termo-id="@termo.Id">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for Manual Creation -->
<div class="modal fade" id="modalCriarTermo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Criar Novo Termo de Referência
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCriarTermo">
                    <div class="form-group">
                        <label for="titulo">Título *</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required 
                               placeholder="Ex: Capacitações da Defesa Civil-ES">
                    </div>

                    <div class="form-group">
                        <label for="demandante">Demandante *</label>
                        <input type="text" class="form-control" id="demandante" name="demandante" required
                               placeholder="Ex: COORDENADORIA ESTADUAL DE PROTEÇÃO E DEFESA CIVIL">
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ano">Ano *</label>
                                <input type="number" class="form-control" id="ano" name="ano" 
                                       value="2026" min="2020" max="2050" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dataInicio">Data Início</label>
                                <input type="text" class="form-control" id="dataInicio" name="dataInicio" 
                                       placeholder="Ex: FEVEREIRO/2026">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dataTermino">Data Término</label>
                                <input type="text" class="form-control" id="dataTermino" name="dataTermino" 
                                       placeholder="Ex: NOVEMBRO/2026">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Após criar o termo, você será redirecionado para a página de edição onde poderá adicionar cursos e profissionais.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnSalvarNovoTermo">
                    <i class="fas fa-save"></i> Criar Termo
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .card-header[data-toggle="collapse"] {
        transition: background-color 0.3s;
    }
    
    .card-header[data-toggle="collapse"]:hover {
        opacity: 0.9;
    }
    
    .card-header .fa-chevron-down {
        transition: transform 0.3s;
    }
    
    .card-header[aria-expanded="true"] .fa-chevron-down {
        transform: rotate(180deg);
    }
</style>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
$(document).ready(function() {
    // Custom file input label
    $('#uploadFile').on('change', function() {
        var fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').text(fileName || 'Nenhum arquivo escolhido');
    });

    // Accordion behavior - close one when opening another
    $('#collapseUpload').on('show.bs.collapse', function() {
        $('#collapseCreate').collapse('hide');
    });
    
    $('#collapseCreate').on('show.bs.collapse', function() {
        $('#collapseUpload').collapse('hide');
    });

    // Open modal for manual creation
    $('#btnAbrirModalCriar').click(function() {
        $('#modalCriarTermo').modal('show');
    });

    // Handle PDF upload
    $('#btnUploadPDF').click(function() {
        var file = $('#uploadFile')[0].files[0];
        var ano = $('#uploadAno').val();

        if (!file) {
            toastr.error('Selecione um arquivo PDF');
            return;
        }

        if (!ano) {
            toastr.error('Informe o ano');
            return;
        }

        var formData = new FormData();
        formData.append('file', file);
        formData.append('ano', ano);

        $.ajax({
            url: '/TermosReferencia/Upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function() {
                $('#btnUploadPDF').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processando...');
            },
            success: function(response) {
    toastr.success('Documento processado com sucesso!');
    window.location.href = '/TermosReferencia/Detalhes/' + response.termoId;
},
            error: function(xhr) {
                var message = 'Erro ao processar PDF';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                toastr.error(message);
            },
            complete: function() {
                $('#btnUploadPDF').prop('disabled', false).html('<i class="fas fa-upload"></i> Upload');
            }
        });
    });

    // Handle manual creation
    $('#btnSalvarNovoTermo').click(function() {
        if (!$('#formCriarTermo')[0].checkValidity()) {
            $('#formCriarTermo')[0].reportValidity();
            return;
        }

        var formData = {
            titulo: $('#titulo').val(),
            demandante: $('#demandante').val(),
            ano: $('#ano').val(),
            dataInicio: $('#dataInicio').val(),
            dataTermino: $('#dataTermino').val()
        };

        $.ajax({
            url: '/TermosReferencia/Criar',
            method: 'POST',
            data: formData,
            beforeSend: function() {
                $('#btnSalvarNovoTermo').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Criando...');
            },
            success: function() {
    toastr.success('Termo excluído com sucesso!');
    $row.fadeOut(function() {
        $(this).remove();
    });
},
            error: function() {
                toastr.error('Erro ao comunicar com o servidor');
            },
            complete: function() {
                $('#btnSalvarNovoTermo').prop('disabled', false).html('<i class="fas fa-save"></i> Criar Termo');
            }
        });
    });
});
// Delete termo
$(document).on('click', '.btn-deletar-termo', function() {
    if (!confirm('Tem certeza que deseja excluir este termo de referência?')) {
        return;
    }

    var termoId = $(this).data('termo-id');
    var $row = $(this).closest('tr');
    
    $.ajax({
        url: '/TermosReferencia/Excluir?id=' + termoId,
        method: 'DELETE',
        data: { id: termoId },
        success: function(response) {
            if (response.success) {
                toastr.success('Termo excluído com sucesso!');
                $row.fadeOut(function() {
                    $(this).remove();
                });
            } else {
                toastr.error(response.message || 'Erro ao excluir');
            }
        },
        error: function() {
            toastr.error('Erro ao comunicar com o servidor');
        }
    });
    // Click row to open details
$('#tabelaTermos tbody').on('click', 'tr', function(e) {
    if ($(e.target).closest('a, button').length) return;
    var termoId = $(this).find('.btn-deletar-termo').data('termo-id');
    if (termoId) {
        window.location.href = '/TermosReferencia/Detalhes/' + termoId;
    }
});
});
</script>
